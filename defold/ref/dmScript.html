<html><head><link rel='stylesheet' type='text/css' href='../defold.css'></head><body><div class='nav'><a class='chevron' href='../index.html'><img src='../svg/chevron-left.svg' alt='Home'></a></div><h1>Script</h1>
<p><p><span class="file">&lt;dmsdk/script/script.h&gt;</span></p>
<p>Built-in scripting functions.</p></p>
<h1><a name='//apple_ref/cpp/Macro/DM_LUA_ERROR' class='dashAnchor'></a><a class='entry' name='DM_LUA_ERROR'>DM_LUA_ERROR</a></h1><div class='brief'><p>helper macro to validate the Lua stack state and throw a lua error.</p></div><p><p>This macro will verify that the Lua stack size hasn't been changed before
throwing a Lua error, which will long-jump out of the current function.
This macro can only be used together with <a href="#DM_LUA_STACK_CHECK">DM_LUA_STACK_CHECK</a> and should
be prefered over manual checking of the stack.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>fmt<p><span class="type">const char*</span> Format string that contains error information.</p></p><p class='param'>args<p><span class="type">...</span> Format string args (variable arg list)</p></p></div><h3>EXAMPLES</h3><div class='examples'><p><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">ModuleFunc</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DM_LUA_STACK_CHECK</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">some_error_check</span><span class="p">(</span><span class="n">L</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">DM_LUA_ERROR</span><span class="p">(</span><span class="s">&quot;some error message&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Macro/DM_LUA_STACK_CHECK' class='dashAnchor'></a><a class='entry' name='DM_LUA_STACK_CHECK'>DM_LUA_STACK_CHECK</a></h1><div class='brief'><p>helper macro to validate the Lua stack state before leaving a function.</p></div><p><p>Diff is the expected difference of the stack size.
If luaL_error, or another function that executes a long-jump, is part of the executed code,
the stack guard cannot be guaranteed to execute at the end of the function.
In that case you should manually check the stack using <code>lua_gettop</code>.
In the case of luaL_error, see <a href="#DM_LUA_ERROR">DM_LUA_ERROR</a>.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p><p class='param'>diff<p><span class="type">int</span> Number of expected items to be on the Lua stack once this struct goes out of scope</p></p></div><h3>EXAMPLES</h3><div class='examples'><p><div class="codehilite"><pre><span></span><span class="n">DM_LUA_STACK_CHECK</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::CheckBuffer' class='dashAnchor'></a><a class='entry' name='dmScript::CheckBuffer'>dmScript::CheckBuffer()</a></h1><div class='brief'><p>retrieve a HBuffer from the supplied lua state</p></div><p><p>Check if the value in the supplied index on the lua stack is a HBuffer and returns it.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p><p class='param'>index<p><span class="type">int</span> Index of the value</p></p></div><h3>RETURN</h3><div class='return'><p>buffer - <p><span class="type">LuaHBuffer*</span> pointer to dmScript::LuaHBuffer</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::GetInstance' class='dashAnchor'></a><a class='entry' name='dmScript::GetInstance'>dmScript::GetInstance()</a></h1><div class='brief'></div><p><p>Retrieve current script instance from the global table and place it on the top of the stack, only valid when set.
(see <a href="#dmScript::GetMainThread">dmScript::GetMainThread</a>)</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::GetMainThread' class='dashAnchor'></a><a class='entry' name='dmScript::GetMainThread'>dmScript::GetMainThread()</a></h1><div class='brief'></div><p><p>Retrieve the main thread lua state from any lua state (main thread or coroutine).</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p></div><h3>RETURN</h3><div class='return'><p>lua_State - <p><span class="type">lua_State*</span> the main thread lua state</p></p></div><h3>EXAMPLES</h3><div class='examples'><p><p>How to create a Lua callback</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">LuaCallbackInfo</span>
<span class="p">{</span>
    <span class="n">LuaCallbackInfo</span><span class="p">()</span> <span class="o">:</span> <span class="n">m_L</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">m_Callback</span><span class="p">(</span><span class="n">LUA_NOREF</span><span class="p">),</span> <span class="n">m_Self</span><span class="p">(</span><span class="n">LUA_NOREF</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">lua_State</span><span class="o">*</span> <span class="n">m_L</span><span class="p">;</span>
    <span class="kt">int</span>        <span class="n">m_Callback</span><span class="p">;</span>
    <span class="kt">int</span>        <span class="n">m_Self</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">RegisterCallback</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">LuaCallbackInfo</span><span class="o">*</span> <span class="n">cbk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span> <span class="o">!=</span> <span class="n">LUA_NOREF</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dmScript</span><span class="o">::</span><span class="n">Unref</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span><span class="p">);</span>
        <span class="n">dmScript</span><span class="o">::</span><span class="n">Unref</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Self</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_L</span> <span class="o">=</span> <span class="n">dmScript</span><span class="o">::</span><span class="n">GetMainThread</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

    <span class="n">luaL_checktype</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">LUA_TFUNCTION</span><span class="p">);</span>
    <span class="n">lua_pushvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
    <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span> <span class="o">=</span> <span class="n">dmScript</span><span class="o">::</span><span class="n">Ref</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">);</span>

    <span class="n">dmScript</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Self</span> <span class="o">=</span> <span class="n">dmScript</span><span class="o">::</span><span class="n">Ref</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">UnregisterCallback</span><span class="p">(</span><span class="n">LuaCallbackInfo</span><span class="o">*</span> <span class="n">cbk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span> <span class="o">!=</span> <span class="n">LUA_NOREF</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">dmScript</span><span class="o">::</span><span class="n">Unref</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span><span class="p">);</span>
        <span class="n">dmScript</span><span class="o">::</span><span class="n">Unref</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Self</span><span class="p">);</span>
        <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span> <span class="o">=</span> <span class="n">LUA_NOREF</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">LuaCallbackInfo</span> <span class="n">g_MyCallbackInfo</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">InvokeCallback</span><span class="p">(</span><span class="n">LuaCallbackInfo</span><span class="o">*</span> <span class="n">cbk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span> <span class="o">==</span> <span class="n">LUA_NOREF</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span> <span class="o">=</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_L</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">top</span> <span class="o">=</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

    <span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Callback</span><span class="p">);</span>

    <span class="c1">// Setup self (the script instance)</span>
    <span class="n">lua_rawgeti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="n">cbk</span><span class="o">-&gt;</span><span class="n">m_Self</span><span class="p">);</span>
    <span class="n">lua_pushvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">dmScript</span><span class="o">::</span><span class="n">SetInstance</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;Hello from extension!&quot;</span><span class="p">);</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">76</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">number_of_arguments</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// instance + 2</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">number_of_arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dmLogError</span><span class="p">(</span><span class="s">&quot;Error running callback: %s&quot;</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">top</span> <span class="o">==</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Start</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DM_LUA_STACK_CHECK</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">RegisterCallback</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_MyCallbackInfo</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Update</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DM_LUA_STACK_CHECK</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">InvokeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_MyCallbackInfo</span><span class="p">);</span>
        <span class="n">UnregisterCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">g_MyCallbackInfo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::IsBuffer' class='dashAnchor'></a><a class='entry' name='dmScript::IsBuffer'>dmScript::IsBuffer()</a></h1><div class='brief'><p>check if the value at #index is a dmScript::LuaHBuffer</p></div><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p><p class='param'>index<p><span class="type">int</span> Index of the value</p></p></div><h3>RETURN</h3><div class='return'><p>boolean - <p><span class="type">boolean</span> true if value at #index is a LuaHBuffer</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::IsInstanceValid' class='dashAnchor'></a><a class='entry' name='dmScript::IsInstanceValid'>dmScript::IsInstanceValid()</a></h1><div class='brief'></div><p><p>Check if the script instance in the lua state is valid. The instance is assumed to have been previously set by <a href="#dmScript::SetInstance">dmScript::SetInstance</a>.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p></div><h3>RETURN</h3><div class='return'><p>boolean - <p><span class="type">bool</span> Returns true if the instance is valid</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::LuaHBuffer' class='dashAnchor'></a><a class='entry' name='dmScript::LuaHBuffer'>dmScript::LuaHBuffer()</a></h1><div class='brief'><p>Lua wrapper for a dmBuffer::HBuffer</p></div><p><p>Holds info about the buffer and who owns it.</p></p><h3>MEMBERS</h3><div class='params'><p class='param'>m_Buffer - <p><span class="type">dmBuffer::HBuffer</span>    The buffer</p></p><p class='param'>m_UseLuaGC - <p><span class="type">bool</span>               If true, it will be garbage collected by Lua. If false, the C++ extension still owns the reference.</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::PushBuffer' class='dashAnchor'></a><a class='entry' name='dmScript::PushBuffer'>dmScript::PushBuffer()</a></h1><div class='brief'><p>push a LuaHBuffer onto the supplied lua state</p></div><p><p>Will increase the stack by 1.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p><p class='param'>buffer<p><span class="type">dmScript::LuaHBuffer</span> buffer to push</p></p></div><h3>EXAMPLES</h3><div class='examples'><p><p>How to push a buffer and give Lua ownership of the buffer (GC)</p>
<div class="codehilite"><pre><span></span><span class="n">dmScript</span><span class="o">::</span><span class="n">LuaHBuffer</span> <span class="n">luabuf</span> <span class="o">=</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">true</span> <span class="p">};</span>
<span class="n">PushBuffer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">luabuf</span><span class="p">);</span>
</pre></div>


<p>How to push a buffer and keep ownership in C++</p>
<div class="codehilite"><pre><span></span><span class="n">dmScript</span><span class="o">::</span><span class="n">LuaHBuffer</span> <span class="n">luabuf</span> <span class="o">=</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">false</span> <span class="p">};</span>
<span class="n">PushBuffer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">luabuf</span><span class="p">);</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::Ref' class='dashAnchor'></a><a class='entry' name='dmScript::Ref'>dmScript::Ref()</a></h1><div class='brief'><p>wrapper for luaL_ref.</p></div><p><p>Creates and returns a reference, in the table at index t, for the object at the
top of the stack (and pops the object).
It also tracks number of global references kept.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p><p class='param'>table<p><span class="type">int</span> table the lua table that stores the references. E.g LUA_REGISTRYINDEX</p></p></div><h3>RETURN</h3><div class='return'><p>reference - <p><span class="type">int</span> the new reference</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::SetInstance' class='dashAnchor'></a><a class='entry' name='dmScript::SetInstance'>dmScript::SetInstance()</a></h1><div class='brief'></div><p><p>Sets the current script instance
Set the value on the top of the stack as the instance into the global table and pops it from the stack.
(see <a href="#dmScript::GetMainThread">dmScript::GetMainThread</a>)</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/dmScript::Unref' class='dashAnchor'></a><a class='entry' name='dmScript::Unref'>dmScript::Unref()</a></h1><div class='brief'><p>wrapper for luaL_unref.</p></div><p><p>Releases reference ref from the table at index t (see luaL_ref).
The entry is removed from the table, so that the referred object can be collected.
It also decreases the number of global references kept</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>L<p><span class="type">lua_State*</span> lua state</p></p><p class='param'>table<p><span class="type">int</span> table the lua table that stores the references. E.g LUA_REGISTRYINDEX</p></p><p class='param'>reference<p><span class="type">int</span> the reference to the object</p></p></div><hr/></body></html>