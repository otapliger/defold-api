<html><head><link rel='stylesheet' type='text/css' href='../defold.css'></head><body><div class='nav'><a class='chevron' href='../index.html'><img src='../svg/chevron-left.svg' alt='Home'></a></div><h1>In-app purchases</h1>
<p><p>Functions and constants for interacting with Apple's In-app purchases
and Google's In-app billing.</p></p>
<h1><a name='//apple_ref/cpp/Variable/iap.PROVIDER_ID_AMAZON' class='dashAnchor'></a><a class='entry' name='iap.PROVIDER_ID_AMAZON'>iap.PROVIDER_ID_AMAZON</a></h1><div class='brief'><p>provider id for Amazon</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.PROVIDER_ID_APPLE' class='dashAnchor'></a><a class='entry' name='iap.PROVIDER_ID_APPLE'>iap.PROVIDER_ID_APPLE</a></h1><div class='brief'><p>provider id for Apple</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.PROVIDER_ID_FACEBOOK' class='dashAnchor'></a><a class='entry' name='iap.PROVIDER_ID_FACEBOOK'>iap.PROVIDER_ID_FACEBOOK</a></h1><div class='brief'><p>provider id for Facebook</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.PROVIDER_ID_GAMEROOM' class='dashAnchor'></a><a class='entry' name='iap.PROVIDER_ID_GAMEROOM'>iap.PROVIDER_ID_GAMEROOM</a></h1><div class='brief'><p>provider id for Facebook Gameroom</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.PROVIDER_ID_GOOGLE' class='dashAnchor'></a><a class='entry' name='iap.PROVIDER_ID_GOOGLE'>iap.PROVIDER_ID_GOOGLE</a></h1><div class='brief'><p>iap provider id for Google</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.REASON_UNSPECIFIED' class='dashAnchor'></a><a class='entry' name='iap.REASON_UNSPECIFIED'>iap.REASON_UNSPECIFIED</a></h1><div class='brief'><p>unspecified error reason</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.REASON_USER_CANCELED' class='dashAnchor'></a><a class='entry' name='iap.REASON_USER_CANCELED'>iap.REASON_USER_CANCELED</a></h1><div class='brief'><p>user canceled reason</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.TRANS_STATE_FAILED' class='dashAnchor'></a><a class='entry' name='iap.TRANS_STATE_FAILED'>iap.TRANS_STATE_FAILED</a></h1><div class='brief'><p>transaction failed state</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.TRANS_STATE_PURCHASED' class='dashAnchor'></a><a class='entry' name='iap.TRANS_STATE_PURCHASED'>iap.TRANS_STATE_PURCHASED</a></h1><div class='brief'><p>transaction purchased state</p></div><hr/><h1><a name='//apple_ref/cpp/Variable/iap.TRANS_STATE_PURCHASING' class='dashAnchor'></a><a class='entry' name='iap.TRANS_STATE_PURCHASING'>iap.TRANS_STATE_PURCHASING</a></h1><div class='brief'><p>transaction purchasing state</p></div><p><p>This is an intermediate mode followed by TRANS_STATE_PURCHASED.
Store provider support dependent.</p></p><hr/><h1><a name='//apple_ref/cpp/Variable/iap.TRANS_STATE_RESTORED' class='dashAnchor'></a><a class='entry' name='iap.TRANS_STATE_RESTORED'>iap.TRANS_STATE_RESTORED</a></h1><div class='brief'><p>transaction restored state</p></div><p><p>This is only available on store providers supporting restoring purchases.</p></p><hr/><h1><a name='//apple_ref/cpp/Variable/iap.TRANS_STATE_UNVERIFIED' class='dashAnchor'></a><a class='entry' name='iap.TRANS_STATE_UNVERIFIED'>iap.TRANS_STATE_UNVERIFIED</a></h1><div class='brief'><p>transaction unverified state, requires verification of purchase</p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.buy' class='dashAnchor'></a><a class='entry' name='iap.buy'>iap.buy()</a></h1><div class='brief'><p>buy product</p></div><p><p>Perform a product purchase.</p>
<p><span class="icon-attention"></span> Calling <code>iap.finish()</code> is required on a successful transaction if
<code>auto_finish_transactions</code> is disabled in project settings.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>id<p><span class="type">string</span> product to buy</p></p><p class='param'>[options]<p><span class="type">table</span> optional parameters as properties. The following parameters can be set:</p>
<ul>
<li><code>request_id</code> (<span class="icon-facebook"></span> Facebook only. Optional custom unique request id to
set for this transaction. The id becomes attached to the payment within the Graph API.)</li>
</ul></p></div><h3>EXAMPLES</h3><div class='examples'><p><div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">iap_listener</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="nb">error</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">error</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
    <span class="c1">-- purchase is successful.</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">date</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">transaction</span><span class="p">.)</span>
    <span class="c1">-- required if auto finish transactions is disabled in project settings</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">iap</span><span class="p">.</span><span class="n">TRANS_STATE_PURCHASED</span><span class="p">)</span> <span class="k">then</span>
      <span class="c1">-- do server-side verification of purchase here..</span>
      <span class="n">iap</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">error</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="n">iap</span><span class="p">.</span><span class="n">set_listener</span><span class="p">(</span><span class="n">iap_listener</span><span class="p">)</span>
    <span class="n">iap</span><span class="p">.</span><span class="n">buy</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">my_iap&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.buy_premium' class='dashAnchor'></a><a class='entry' name='iap.buy_premium'>iap.buy_premium()</a></h1><div class='brief'><p>purchase a premium license</p></div><p><p><span class="icon-gameroom"></span> Performs a purchase of a premium game license. The purchase transaction
is handled like regular iap purchases; calling the currently set iap_listener with the
transaction results.</p>
<p><span class="icon-attention"></span> This function does not work when testing the application
locally in the Gameroom client.</p></p><h3>EXAMPLES</h3><div class='examples'><p><div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">iap_listener</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="nb">error</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">error</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
    <span class="c1">-- purchase is ok</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">date</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">transaction</span><span class="p">.)</span>
    <span class="c1">-- required if auto finish transactions is disabled in project settings</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">iap</span><span class="p">.</span><span class="n">TRANS_STATE_PURCHASED</span><span class="p">)</span> <span class="k">then</span>
      <span class="c1">-- do server-side verification of purchase here..</span>
      <span class="n">iap</span><span class="p">.</span><span class="n">finish</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">error</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="c1">-- set the listener function for iap transactions</span>
  <span class="n">iap</span><span class="p">.</span><span class="n">set_listener</span><span class="p">(</span><span class="n">iap_listener</span><span class="p">)</span>
  <span class="c1">-- purchase premium license</span>
  <span class="n">iap</span><span class="p">.</span><span class="n">buy_premium</span><span class="p">()</span>
<span class="k">end</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.finish' class='dashAnchor'></a><a class='entry' name='iap.finish'>iap.finish()</a></h1><div class='brief'><p>finish buying product</p></div><p><p>Explicitly finish a product transaction.</p>
<p><span class="icon-attention"></span> Calling iap.finish is required on a successful transaction
if <code>auto_finish_transactions</code> is disabled in project settings. Calling this function
with <code>auto_finish_transactions</code> set will be ignored and a warning is printed.
The <code>transaction.state</code> field must equal <code>iap.TRANS_STATE_PURCHASED</code>.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>transaction<p><span class="type">table</span> transaction table parameter as supplied in listener callback</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.get_provider_id' class='dashAnchor'></a><a class='entry' name='iap.get_provider_id'>iap.get_provider_id()</a></h1><div class='brief'><p>get current provider id</p></div><h3>RETURN</h3><div class='return'><p>id - <p><span class="type">constant</span> provider id.</p>
<ul>
<li><code>iap.PROVIDER_ID_GOOGLE</code></li>
<li><code>iap.PROVIDER_ID_AMAZON</code></li>
<li><code>iap.PROVIDER_ID_APPLE</code></li>
<li><code>iap.PROVIDER_ID_FACEBOOK</code></li>
<li><code>iap.PROVIDER_ID_GAMEROOM</code></li>
</ul></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.has_premium' class='dashAnchor'></a><a class='entry' name='iap.has_premium'>iap.has_premium()</a></h1><div class='brief'><p>check if user has already purchased premium license</p></div><p><p><span class="icon-gameroom"></span> Checks if a license for the game has been purchased by the user.
You should provide a callback function that will be called with the result of the check.</p>
<p><span class="icon-attention"></span> This function does not work when testing the application
locally in the Gameroom client.</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>callback<p><span class="type">function(self, has_premium)</span> result callback</p>
<dl>
<dt><code>self</code></dt>
<dd><span class="type">object</span> The current object.</dd>
<dt><code>has_premium</code></dt>
<dd><span class="type">boolean</span> <code>true</code> if the user has premium license, <code>false</code> otherwise.</dd>
</dl></p></div><h3>EXAMPLES</h3><div class='examples'><p><div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">premium_result</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">has_premium</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">has_premium</span> <span class="k">then</span>
     <span class="c1">-- User has purchased this premium game.</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">init</span><span class="p">()</span>
  <span class="c1">-- check is user has bought the game</span>
  <span class="n">iap</span><span class="p">.</span><span class="n">has_premium</span><span class="p">(</span><span class="n">premium_result</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.list' class='dashAnchor'></a><a class='entry' name='iap.list'>iap.list()</a></h1><div class='brief'><p>list in-app products</p></div><p><p>Get a list of all avaliable iap products. Products are described as a <span class="type">table</span>
with the following fields:</p>
<dl>
<dt><code>ident</code></dt>
<dd>The product identifier.</dd>
<dt><code>title</code></dt>
<dd>The product title.</dd>
<dt><code>description</code></dt>
<dd>The product description.</dd>
<dt><code>price</code></dt>
<dd>The price of the product.</dd>
<dt><code>price_string</code></dt>
<dd>The price of the product, as a formatted string (amount and currency symbol).</dd>
<dt><code>currency_code</code> <span class="icon-ios"></span> <span class="icon-googleplay"></span> <span class="icon-facebook"></span></dt>
<dd>The currency code. On Google Play, this reflects the merchant's locale, instead of the user's.</dd>
</dl>
<p><span class="icon-attention"></span> Nested calls, that is calling <code>iap.list()</code> from within the callback is
not supported. Doing so will result in call being ignored with the engine reporting
"Unexpected callback set".</p></p><h3>PARAMETERS</h3><div class='params'><p class='param'>ids<p><span class="type">table</span> table (array) of identifiers to get products from</p></p><p class='param'>callback<p><span class="type">function(self, products, error)</span> result callback</p>
<dl>
<dt><code>self</code></dt>
<dd><span class="type">object</span> The current object.</dd>
<dt><code>products</code></dt>
<dd><span class="type">table</span> Table describing the available iap products. See above for details.</dd>
<dt><code>error</code></dt>
<dd><span class="type">table</span> a table containing error information. <code>nil</code> if there is no error.
- <code>error</code> (the error message)</dd>
</dl></p></div><h3>EXAMPLES</h3><div class='examples'><p><div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">iap_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span> <span class="nb">error</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">error</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">p</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1">-- present the product</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">title</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">description</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="n">iap</span><span class="p">.</span><span class="n">list</span><span class="p">({</span><span class="s2">&quot;</span><span class="s">my_iap&quot;</span><span class="p">},</span> <span class="n">iap_callback</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.restore' class='dashAnchor'></a><a class='entry' name='iap.restore'>iap.restore()</a></h1><div class='brief'><p>restore products (non-consumable)</p></div><p><p>Restore previously purchased products.</p></p><h3>RETURN</h3><div class='return'><p>success - <p><span class="type">boolean</span> <code>true</code> if current store supports handling
restored transactions, otherwise <code>false</code>.</p></p></div><hr/><h1><a name='//apple_ref/cpp/Function/iap.set_listener' class='dashAnchor'></a><a class='entry' name='iap.set_listener'>iap.set_listener()</a></h1><div class='brief'><p>set purchase transaction listener</p></div><p><p>Set the callback function to receive purchase transaction events. Transactions are
described as a <span class="type">table</span> with the following fields:</p>
<dl>
<dt><code>ident</code></dt>
<dd>The product identifier.</dd>
<dt><code>state</code></dt>
<dd>The transaction state. See <code>iap.TRANS_STATE_*</code>.</dd>
<dt><code>date</code></dt>
<dd>The date and time for the transaction.</dd>
<dt><code>trans_ident</code></dt>
<dd>The transaction identifier. This field is only set when <code>state</code> is TRANS_STATE_RESTORED,
TRANS_STATE_UNVERIFIED or TRANS_STATE_PURCHASED.</dd>
<dt><code>receipt</code></dt>
<dd>The transaction receipt. This field is only set when <code>state</code> is TRANS_STATE_PURCHASED
or TRANS_STATE_UNVERIFIED.</dd>
<dt><code>original_trans</code> <span class="icon-apple"></span></dt>
<dd>Apple only. The original transaction. This field is only set when <code>state</code> is
TRANS_STATE_RESTORED.</dd>
<dt><code>signature</code> <span class="icon-googleplay"></span></dt>
<dd>Google Play only. A string containing the signature of the purchase data that was signed
with the private key of the developer.</dd>
<dt><code>request_id</code> <span class="icon-facebook"></span></dt>
<dd>Facebook only. This field is set to the optional custom unique request id <code>request_id</code>
if set in the <code>iap.buy()</code> call parameters.</dd>
<dt><code>purchase_token</code> <span class="icon-gameroom"></span></dt>
<dd>Facebook Gameroom only. The purchase token.</dd>
<dt><code>currency</code> <span class="icon-gameroom"></span></dt>
<dd>Facebook Gameroom only. The currency used for the purchase.</dd>
<dt><code>amount</code> <span class="icon-gameroom"></span></dt>
<dd>Facebook Gameroom only. The amount the player will be charged for a single unit
of this product.</dd>
<dt><code>quantity</code> <span class="icon-gameroom"></span></dt>
<dd>Facebook Gameroom only. The quantity of this item the user is purchasing.</dd>
<dt><code>user_id</code> <span class="icon-amazon"></span></dt>
<dd>Amazon Pay only. The user ID.</dd>
<dt><code>is_sandbox_mode</code> <span class="icon-amazon"></span></dt>
<dd>Amazon Pay only. If <code>true</code>, the SDK is running in Sandbox mode. This only allows
interactions with the Amazon AppTester. Use this mode only for testing locally.</dd>
<dt><code>cancel_date</code> <span class="icon-amazon"></span></dt>
<dd>Amazon Pay only. The cancel date for the purchase. This field is only set if the
purchase is canceled.</dd>
<dt><code>canceled</code> <span class="icon-amazon"></span></dt>
<dd>Amazon Pay only. Is set to <code>true</code> if the receipt was canceled or has expired;
otherwise <code>false</code>.</dd>
</dl></p><h3>PARAMETERS</h3><div class='params'><p class='param'>listener<p><span class="type">function(self, transaction, error)</span> listener callback function.
Pass an empty function if you no longer wish to receive callbacks.</p>
<dl>
<dt><code>self</code></dt>
<dd><span class="type">object</span> The current object.</dd>
<dt><code>transaction</code></dt>
<dd><span class="type">table</span> a table describing the transaction. See above for details.</dd>
<dt><code>error</code></dt>
<dd><span class="type">table</span> a table containing error information. <code>nil</code> if there is no error.
- <code>error</code> (the error message)
- <code>reason</code> (the reason for the error, see <code>iap.REASON_*</code>)</dd>
</dl></p></div><hr/></body></html>